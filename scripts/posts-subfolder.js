// posts-subfolder
const { join } = require('path');
const { readdirSync } = require('fs');
const moment = require('moment');

// Organize posts in subfolders (by year or whatever),
// but don't add the subfolder name to generated post links.
// e.g. "source/_posts/2019/slug.md" => "https://hexo.example/slug/"
hexo.extend.filter.register('post_permalink', function (permalink) {
  // Folders that should be reserved in post link
  const excludes = [];

  const postDir = join(this.source_dir, '_posts');
  const folders = readdirSync(postDir, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name)
    .filter(dir => !excludes.includes(dir));

  for (const name of folders) {
    if (permalink.startsWith(`${name}/`)) {
      // Remove first occurrence
      return permalink.replace(`${name}/`, '');
    }
  }
});

// Organize post files generated by `hexo new` by year.
// @see hexo/lib/plugins/filter/new_post_path.js
hexo.extend.filter.register('new_post_path', data => {
  const year = moment(data.date || Date.now()).format('YYYY');
  data.path = join(year, data.slug);
  return data;
}, 1); // High priority
