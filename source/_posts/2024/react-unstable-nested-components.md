---
title: çœŸçš„ä¸å¯ä»¥åœ¨ React ç»„ä»¶å†…éƒ¨åµŒå¥—å®šä¹‰å­ç»„ä»¶å—ï¼Ÿ
date: 2024-02-26
updated: 2024-02-26
categories: æŠ€æœ¯
tags:
  - å‰ç«¯
  - React
---

æœ€è¿‘åœ¨ Code Review æ—¶ï¼Œçœ‹åˆ°æœ‰åŒäº‹å†™äº†è¿™æ ·çš„ä»£ç ï¼š

```jsx
function TodoList() {
  const [list, setList] = useState([]);

  const TodoItem = useCallback((props) => {
    return <li>{props.text}</li>;
  }, []);

  return <ul>{list.map((item, index) => <TodoItem key={index} text={item} />)}</ul>;
}
```

æœ‰ç»éªŒçš„ React å¼€å‘è€…è‚¯å®šä¸€ä¸‹å­å°±çœ‹å‡ºé—®é¢˜äº†ï¼š**åœ¨ç»„ä»¶å†…éƒ¨åµŒå¥—å®šä¹‰ç»„ä»¶ï¼Œä¼šå¯¼è‡´å­ç»„ä»¶æ¯æ¬¡éƒ½é‡æ–°æŒ‚è½½**ã€‚å› ä¸ºæ¯æ¬¡æ¸²æŸ“æ—¶ï¼Œåˆ›å»ºçš„å‡½æ•°ç»„ä»¶å…¶å®éƒ½æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚

ä½†æ˜¯ä»–åˆæœ‰åŒ…äº† `useCallback` è®©å¼•ç”¨ä¿æŒä¸€è‡´ï¼Œå¥½åƒåˆæ²¡ä»€ä¹ˆé—®é¢˜â€¦â€¦ï¼Ÿ

è¿™æ³¢éªšæ“ä½œè®©æˆ‘çªç„¶æœ‰ç‚¹æ‹¿ä¸å‡†äº†ï¼Œæ‰€ä»¥ä»Šå¤©å’±ä»¬ä¸€èµ·æ¥éªŒè¯ä¸€ä¸‹ï¼Œç”¨ `useMemo` æˆ–è€… `useCallback` åŒ…è£¹åµŒå¥—å®šä¹‰çš„å­ç»„ä»¶ï¼Œå¯¹ React æ¸²æŸ“ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚ä»¥åŠå¦‚æœæœ‰å½±å“ï¼Œåº”è¯¥å¦‚ä½•ç”¨æ›´åˆé€‚çš„æ–¹æ³•é‡æ„ã€‚

<!--more-->

## TL;DR

å…ˆè¯´ç»“è®ºï¼š

> **æ°¸è¿œä¸è¦åœ¨ React ç»„ä»¶å†…éƒ¨åµŒå¥—å®šä¹‰å­ç»„ä»¶ã€‚**

å¦‚æœä½ æœ‰ç±»ä¼¼çš„ä»£ç ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ›¿ä»£ï¼š

1. æŠŠå­ç»„ä»¶ç§»åˆ°æœ€å¤–å±‚å»ï¼Œå°†åŸæœ‰çš„ä¾èµ–é¡¹ä½œä¸º props ä¼ å…¥
2. æŠŠå­ç»„ä»¶æ”¹ä¸ºã€Œæ¸²æŸ“å‡½æ•°ã€ï¼Œé€šè¿‡è°ƒç”¨å‡½æ•°æ’å…¥ JSX èŠ‚ç‚¹

ä¸ºä»€ä¹ˆï¼Ÿè¯·æ¥ç€å¾€ä¸‹çœ‹ã€‚

## ç»„ä»¶é‡æ–°æŒ‚è½½ä¼šé€ æˆçš„é—®é¢˜

æ¥çœ‹è¿™æ®µä»£ç ï¼ˆå¯ä»¥åœ¨ [StackBlitz Demo](https://stackblitz.com/edit/react-unstable-nested-components?file=src%2FApp.tsx) ä¸­è¿è¡Œï¼‰ï¼š

```jsx
function TodoList() {
  const [list, setList] = useState([]);

  // åµŒå¥—å®šä¹‰å­ç»„ä»¶ï¼ˆå¥½å­©å­ä¸è¦å­¦å“¦ï¼‰
  const TodoItem = (props) => {
    return <li>{props.text}</li>;
  };

  const handleAdd = () => setList([...list, `Item ${list.length + 1}`]);

  return (
    <div>
      <button onClick={handleAdd}>Add</button>
      {/* æ¸²æŸ“åˆšæ‰å®šä¹‰çš„å­ç»„ä»¶ */}
      <ul>
        {list.map((item, index) => (
          <TodoItem key={index} text={item} />
        ))}
      </ul>
    </div>
  );
}
```

å¯èƒ½ä¸å°‘åˆå­¦è€…éƒ½å†™å‡ºè¿‡ç±»ä¼¼çš„ä»£ç ï¼šJavaScript è¯­è¨€å¯ä»¥åµŒå¥—å®šä¹‰å‡½æ•°ï¼ŒReact å‡½æ•°å¼ç»„ä»¶å°±æ˜¯å‡½æ•°ï¼Œé‚£ React ç»„ä»¶ä¸ä¹Ÿå¯ä»¥åµŒå¥—å®šä¹‰ï¼Ÿ

è¿˜çœŸä¸æ˜¯è¿™ä¹ˆå›äº‹ã€‚æˆ‘ä»¬æ¥å®é™…è¿è¡Œä¸€ä¸‹è¿™æ®µä»£ç çœ‹çœ‹ï¼š

> Tips: è¿™é‡Œä½¿ç”¨äº† [`useTilg`](https://github.com/shuding/tilg) è¿™ä¸ªåº“æ¥å±•ç¤ºç»„ä»¶ç”Ÿå‘½å‘¨æœŸã€‚

![nested-component](react-unstable-nested-components/nested-component.png)

å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡ç‚¹å‡» Add æŒ‰é’®åœ¨ `<TodoList/>` åˆ—è¡¨ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œä¹‹å‰æ—§çš„ `<TodoItem/>` ç»„ä»¶å®ä¾‹å°±ä¼šè¢«å¸è½½ (unmount)ã€é”€æ¯ã€‚React ä¼šåˆ›å»ºå…¨æ–°çš„ç»„ä»¶å®ä¾‹ï¼Œç„¶åå†æŒ‚è½½ (mount) ä¸Šå»ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ**è¿™äº›ç»„ä»¶å®ä¾‹å…¨éƒ½å˜æˆä¸€æ¬¡æ€§çš„äº†**ã€‚

è¿™è¿˜åªæ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå¦‚æœæ˜¯å®é™…åº”ç”¨åœºæ™¯ï¼Œä¸€ä¸ªç»„ä»¶å’Œå®ƒçš„å­ç»„ä»¶ä¸­ï¼Œå¯èƒ½åŒ…å«äº†æˆç™¾ä¸Šåƒä¸ª DOM èŠ‚ç‚¹ã€‚å¦‚æœæ¯æ¬¡çŠ¶æ€æ›´æ–°éƒ½ä¼šå¯¼è‡´è¿™äº›ç»„ä»¶å’Œå¯¹åº”çš„ DOM èŠ‚ç‚¹è¢«å¸è½½ã€åˆ›å»ºã€é‡æ–°æŒ‚è½½â€¦â€¦é‚£åº”ç”¨æ€§èƒ½å¯å°±æ˜¯ã€Œç”»é¢å¤ªç¾æˆ‘ä¸æ•¢çœ‹ã€äº†ã€‚

æ›´ä¸¥é‡çš„æ˜¯ï¼Œç»„ä»¶çš„å¸è½½è¿˜ä¼šå¯¼è‡´å…¶å†…éƒ¨çš„[çŠ¶æ€å…¨éƒ¨ä¸¢å¤±](https://codepen.io/ariperkkio/pen/vYLodLB)ã€‚

é‚£æ€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿè¿™è¦ä» React çš„æ¸²æŸ“æœºåˆ¶ï¼Œä»¥åŠ Reconciliation æµç¨‹è¯´èµ·ã€‚

## React æ¸²æŸ“æœºåˆ¶ä¹‹ Reconciliation

æˆ‘ä»¬çŸ¥é“ React çš„æ¸²æŸ“å¤§è‡´å¯ä»¥åˆ†ä¸º[ä¸¤ä¸ªé˜¶æ®µ](https://react.dev/learn/render-and-commit)ï¼š

1. `Render` é˜¶æ®µï¼šæ‰§è¡Œç»„ä»¶çš„æ¸²æŸ“æ–¹æ³•ï¼Œ**æ‰¾å‡ºæ›´æ–°å‰åèŠ‚ç‚¹æ ‘çš„å˜åŒ–**ï¼Œè®¡ç®—éœ€è¦æ‰§è¡Œçš„æ”¹åŠ¨ï¼›
2. `Commit` é˜¶æ®µï¼šå·²ç»çŸ¥é“äº†éœ€è¦æ‰§è¡Œå“ªäº›æ”¹åŠ¨ï¼Œäºæ˜¯**æ“ä½œçœŸå® DOM** å®ŒæˆèŠ‚ç‚¹çš„ä¿®æ”¹ã€‚

å…¶ä¸­ï¼Œã€Œæ‰¾å‡ºå˜åŒ– + è®¡ç®—æ”¹åŠ¨ã€è¿™ä¸ªè¿‡ç¨‹å°±è¢«å«åš `Reconciliation` (åè°ƒ)ã€‚React çš„åè°ƒç®—æ³•å¯ä»¥åœ¨ä¿è¯æ•ˆç‡çš„åŒæ—¶ï¼Œæœ€å¤§ç¨‹åº¦å¤ç”¨å·²æœ‰çš„ DOMï¼Œä½¿å¾—å¯¹ DOM åšå‡ºçš„ä¿®æ”¹å°½é‡å°ã€‚

![render-and-commit](react-unstable-nested-components/render-and-commit.png)

*â–² å›¾ç‰‡æ¥è‡ªï¼š[Render and Commit â€“ React](https://react.dev/learn/render-and-commit)*

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒReact æ€ä¹ˆçŸ¥é“ä¸€ä¸ªç»„ä»¶å¯¹åº”çš„ DOM éœ€è¦æ›´æ–°å‘¢ï¼Ÿ

ç®€å•æ¥è¯´ï¼ŒReact åœ¨æ¯”è¾ƒä¸¤æ£µ Fiber æ ‘æ—¶ï¼Œä¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼š

1. å¦‚æœèŠ‚ç‚¹ç±»å‹å’Œä¹‹å‰ä¸€è‡´
    1. å¯¹äº DOM å…ƒç´ ï¼Œä¿æŒå…ƒç´ å®ä¾‹ä¸å˜ï¼Œä»…æ›´æ–°æœ‰å˜åŒ–çš„å±æ€§
    2. å¯¹äºç»„ä»¶å…ƒç´ ï¼Œéœ€è¦é‡æ¸²æŸ“çš„ï¼Œä½¿ç”¨æ–°å±æ€§è°ƒç”¨ç»„ä»¶æ¸²æŸ“æ–¹æ³•
2. å¦‚æœèŠ‚ç‚¹ç±»å‹æœ‰æ”¹å˜
    1. å¸è½½è¯¥èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹ âš ï¸
    2. å°†å¯¹åº”çš„ DOM å…ƒç´ æ ‡è®°ä¸ºå¾…åˆ é™¤
    3. åˆ›å»ºæ–°çš„èŠ‚ç‚¹
    4. å°†æ–°çš„ DOM å…ƒç´ æ ‡è®°ä¸ºå¾…æ’å…¥

ä¸Šé¢æ‰€è¯´çš„å­ç»„ä»¶è¢«å¸è½½å†æŒ‚è½½ã€çŠ¶æ€ä¸¢å¤±ç­‰é—®é¢˜ï¼Œå…¶å®éƒ½æ˜¯å› ä¸ºå®ƒä»¬**è¢«åˆ¤æ–­ä¸ºäº†ã€ŒèŠ‚ç‚¹ç±»å‹æœ‰æ”¹å˜ã€**ã€‚

## å¼•ç”¨ç›¸ç­‰æ€§ä¸ç»„ä»¶é‡æ¸²æŸ“

åœ¨ JavaScript ä¸­ï¼Œæ¯”è¾ƒå€¼æ—¶æœ‰ä¸¤ç§ç›¸ç­‰æ€§ï¼š

- **å€¼ç›¸ç­‰æ€§** (Value Equality)ï¼Œå³ä¸¤ä¸ªå€¼ç±»å‹ä¸€è‡´ï¼Œå†…å®¹ä¹Ÿä¸€è‡´
- **å¼•ç”¨ç›¸ç­‰æ€§** (Reference Equality)ï¼Œå³ä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ¨å†…å­˜ä¸­æŒ‡å‘åŒä¸€å—åŒºåŸŸ

ä¸¾ä¸ªä¾‹å­ï¼š

```js
// ä¸¤ä¸ªé•¿å¾—ä¸€æ ·çš„å¯¹è±¡
const a = { name: 'Anon Tokyo' };
const b = { name: 'Anon Tokyo' };

// "å¼•ç”¨ç›¸ç­‰æ€§" æ¯”è¾ƒ - false
console.log(a === b);
console.log(Object.is(a, b));

// "å€¼ç›¸ç­‰æ€§" æ¯”è¾ƒ - true
console.log(lodash.isEqual(a, b));
console.log(a.name === b.name);
```

JavaScript å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥è¿™å¯¹äºå‡½æ•°ï¼ˆReact ç»„ä»¶ï¼‰ä¹Ÿæˆç«‹ã€‚

åˆ°è¿™é‡Œé—®é¢˜å°±æ¯”è¾ƒæ˜æœ—äº†ã€‚

```jsx
function TodoList() {
  const [list, setList] = useState([]);

  // WARN: è¿™ä¸ªè¯­å¥æ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ TodoItem å‡½æ•°ç»„ä»¶ï¼
  const TodoItem = (props) => {
    return <li>{props.text}</li>;
  };

  return <ul>{list.map((item, index) => <TodoItem key={index} text={item} />)}</ul>;
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæ¯æ¬¡ `<TodoList/>` ç»„ä»¶é‡æ¸²æŸ“æ—¶ï¼ˆå³ `TodoList` å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼‰ï¼Œå…¶å†…éƒ¨åˆ›å»ºçš„ `TodoItem` éƒ½æ˜¯ä¸€ä¸ªå…¨æ–°çš„å‡½æ•°ç»„ä»¶ã€‚

è™½ç„¶å®ƒä»¬é•¿å¾—ä¸€æ ·ï¼Œä½†å®ƒä»¬çš„ã€Œå¼•ç”¨ç›¸ç­‰æ€§ã€æ˜¯ä¸æˆç«‹çš„ã€‚

å›åˆ°ä¸Šä¸€èŠ‚ä»‹ç»çš„æ¸²æŸ“æµç¨‹ä¸­ï¼Œ[React åœ¨æ¯”è¾ƒèŠ‚ç‚¹çš„ `type` æ—¶](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactChildFiber.new.js#L405)ï¼Œä½¿ç”¨çš„æ˜¯ `===` ä¸¥æ ¼ç›¸ç­‰ã€‚ä¹Ÿå°±æ˜¯è¯´åƒä¸Šé¢é‚£æ ·ä¸åŒçš„å‡½æ•°å¼•ç”¨ï¼Œ**ä¼šè¢«è§†ä½œä¸åŒçš„ç»„ä»¶ç±»å‹**ã€‚è¿›è€Œå¯¼è‡´åœ¨è§¦å‘é‡æ¸²æŸ“æ—¶ï¼Œè¯¥ç»„ä»¶çš„èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹å…¨éƒ¨è¢«å¸è½½ï¼Œå†…éƒ¨çš„çŠ¶æ€ä¹Ÿè¢«å…¨éƒ¨ä¸¢å¼ƒã€‚

## å¦‚æœæˆ‘ç”¨ useMemo åŒ…ä¸€ä¸‹å‘¢

åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†ã€Œåœ¨ç»„ä»¶å†…éƒ¨åµŒå¥—å®šä¹‰ç»„ä»¶ã€ä¼šé€ æˆé—®é¢˜çš„åŸç†ã€‚

è¿™æ—¶å€™å¯èƒ½å°±æœ‰å°æœºçµé¬¼è¦é—®äº†ï¼Œæ—¢ç„¶ç»„ä»¶æ¯æ¬¡éƒ½è¢«åˆ¤æ–­ä¸ºæ˜¯ä¸åŒ `type` çš„åŸå› æ˜¯å¯¹è±¡å¼•ç”¨ä¸åŒï¼Œé‚£æˆ‘ç”¨ `useMemo` / `useCallback` Hooksï¼Œè®©å®ƒæ¯æ¬¡éƒ½è¿”å›ç›¸åŒçš„å‡½æ•°å¯¹è±¡ä¸å°±è¡Œäº†ï¼Ÿ

èƒ½è€ƒè™‘åˆ°è¿™ä¸€å±‚çš„éƒ½æ˜¯çˆ±åŠ¨è„‘ç­‹çš„åŒå­¦ï¼Œç‚¹ä¸ªèµï¼è®©æˆ‘ä»¬å†æ¥è¯•éªŒä¸€ä¸‹ï¼š

```jsx
function TodoList() {
  const [list, setList] = useState([]);

  // useMemo å…è®¸æˆ‘ä»¬ç¼“å­˜ä¸€ä¸ªå€¼ï¼Œæ¯æ¬¡é‡æ¸²æŸ“æ—¶æ‹¿åˆ°çš„ç¼“å­˜æ˜¯ä¸€æ ·çš„
  // è¿™é‡Œæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªå‡½æ•°ç»„ä»¶ï¼Œè®© useMemo æŠŠè¿™ä¸ªå­ç»„ä»¶çš„å‡½æ•°å¯¹è±¡ç¼“å­˜ä¸‹æ¥
  const TodoItem = useMemo(
    () => (props) => {
      return <li>{props.text}</li>;
    },
    []
  );

  // æˆ–è€…ç”¨ useCallback ä¹Ÿå¯ä»¥ï¼Œéƒ½ä¸€æ ·
  // const TodoItem = useCallback((props) => {
  //   return <li>{props.text}</li>;
  // }, []);

  const handleAdd = () => setList([...list, `Item ${list.length + 1}`]);

  return (
    <div>
      <button onClick={handleAdd}>Add</button>
      <ul>
        {list.map((item, index) => (
          <TodoItem key={index} text={item} />
        ))}
      </ul>
    </div>
  );
}
```

![nested-usememo](react-unstable-nested-components/nested-usememo.png)

å¯ä»¥çœ‹åˆ°ï¼ŒåŒ…ä¸€å±‚ `useMemo` ä¹‹åï¼Œå­ç»„ä»¶ç¡®å®ä¸ä¼šå†è¢« unmount äº†ã€‚çœ‹èµ·æ¥ååˆ†æ­£å¸¸å‘¢ï¼

è®©æˆ‘ä»¬å†æ‹¿ `React.memo` æ¥åŒ…ä¸€ä¸‹ï¼Œåœ¨ `props` ç›¸åŒæ—¶è·³è¿‡ä¸å¿…è¦çš„é‡æ¸²æŸ“ï¼š

```jsx
const TodoItem = useMemo(
  () =>
    memo((props) => {
      return <li>{props.text}</li>;
    }),
  []
);
```

![nested-usememo-memo](react-unstable-nested-components/nested-usememo-memo.png)

OHHHHHHHHH!!

[å¦‚æœä¸€ä¸ªä¸œè¥¿çœ‹èµ·æ¥åƒé¸­å­ï¼Œå«èµ·æ¥ä¹Ÿåƒé¸­å­ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯é¸­å­ã€‚](https://en.wikipedia.org/wiki/Duck_typing)

åŒç†ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡ä¸€ç³»åˆ—æ“ä½œå¯ä»¥è®©ã€ŒåµŒå¥—å®šä¹‰çš„ React ç»„ä»¶ã€åœ¨æ¸²æŸ“æ—¶è¡¨ç°å¾—ä¸ã€Œåœ¨å¤–å±‚å®šä¹‰çš„ç»„ä»¶ã€ä¸€è‡´ï¼Œé‚£æ˜¯ä¸æ˜¯å°±æ„å‘³ç€è¿™ç§æ“ä½œå…¶å®ä¹Ÿæ˜¯ OK çš„å‘¢ï¼Ÿ

å—¯â€¦â€¦ç­”æ¡ˆæ˜¯ï¼šæ²¡é‚£ä¹ˆç®€å•ã€‚

> ç¨å¾®åä¸ªé¢˜ï¼Œä½ å¯èƒ½ä¼šå¥½å¥‡ Hooks å’Œ memo ä¸ºä»€ä¹ˆä¹Ÿå¯ä»¥åœ¨åµŒå¥—å®šä¹‰çš„å­ç»„ä»¶å†…æ­£å¸¸ä½¿ç”¨ï¼Œå› ä¸ºè¿™çœ‹èµ·æ¥å’Œæˆ‘ä»¬å¹³æ—¶çš„ç”¨æ³•å®Œå…¨ä¸åŒã€‚
>
> å®é™…ä¸Šä¸ç®¡æ˜¯æ¨¡å—é¡¶å±‚å®šä¹‰çš„å‡½æ•°ç»„ä»¶ï¼Œè¿˜æ˜¯åµŒå¥—å®šä¹‰çš„å‡½æ•°ç»„ä»¶ï¼Œåœ¨ React Reconciler çœ‹æ¥éƒ½æ˜¯ç‹¬ç«‹çš„ç»„ä»¶ç±»å‹ï¼Œä¸”åœ¨æ¸²æŸ“æ—¶éƒ½æœ‰ç€è‡ªå·±çš„ Fiber èŠ‚ç‚¹æ¥å‚¨å­˜çŠ¶æ€ï¼Œè€Œå®šä¹‰è¯¥å‡½æ•°çš„ä½œç”¨åŸŸæ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ã€‚æƒ³æƒ³çœ‹ï¼šHOC é«˜é˜¶ç»„ä»¶æœ‰æ—¶å€™ä¹Ÿä¼šè¿”å›å†…è”å®šä¹‰çš„å‡½æ•°ç»„ä»¶ï¼Œå…¶å®æ˜¯ä¸€ä¸ªé“ç†ã€‚

## useMemo çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥

**ç¬¬ä¸€ç‚¹ï¼Œ`useMemo` å’Œ `useCallback` çš„ç¼“å­˜å¹¶éå®Œå…¨å¯é ã€‚**

åœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œç¼“å­˜çš„å€¼ä¼šè¢« React ä¸¢å¼ƒã€‚å¦‚æœç¼“å­˜å¤±æ•ˆï¼Œå‡½æ•°ç»„ä»¶å°±ä¼šè¢«é‡æ–°åˆ›å»ºï¼ŒåŒæ ·ä¼šè¢«åˆ¤æ–­ä¸ºæ˜¯ä¸åŒçš„ç»„ä»¶ç±»å‹ã€‚React å®˜æ–¹è‚¯å®šä¸ä¼šæ¨èä½ æŠŠ Hooks ç”¨äºè¿™ç§æ­ªé—¨é‚ªé“çš„ç”¨é€”ã€‚

> In the future, React may add more features that take advantage of throwing away the cacheâ€”for example, if React adds built-in support for virtualized lists in the future, it would make sense to throw away the cache for items that scroll out of the virtualized table viewport. This should be fine if you rely on useMemo solely as a performance optimization.
>
> Ref: [useMemo â€“ React](https://react.dev/reference/react/useMemo)

**ç¬¬äºŒç‚¹ï¼Œ`useMemo` å’Œ `useCallback` éƒ½æœ‰ä¾èµ–æ•°ç»„ã€‚**

è™½ç„¶ä¸Šé¢çš„ç¤ºä¾‹é‡ŒåµŒå¥—ç»„ä»¶å®šä¹‰çš„ä¾èµ–æ•°ç»„éƒ½æ˜¯ç©ºçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å†æƒ³æƒ³ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šæƒ³è¦åœ¨ç»„ä»¶å†…éƒ¨å®šä¹‰å­ç»„ä»¶ï¼Œè€Œéå°†å…¶æ‹†æˆä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶å‘¢ï¼Ÿæœ€ä¸»è¦çš„åŸå› å°±æ˜¯ï¼Œè¿™ä¸ªå­ç»„ä»¶æƒ³è¦ç›´æ¥è®¿é—®çˆ¶ç»„ä»¶å‡½æ•°ä½œç”¨åŸŸä¸­çš„æŸäº›å˜é‡ã€‚

```jsx
function TodoList() {
  const [list, setList] = useState([]);

  const TodoItem = useMemo(
    () =>
      memo((props) => {
        // æ³¨æ„çœ‹ï¼Œè¿™é‡Œå­ç»„ä»¶ç›´æ¥ä½¿ç”¨äº†çˆ¶çº§ä½œç”¨åŸŸä¸­çš„ list å˜é‡
        return <li>{`${props.text} of ${list.length}`}</li>;
      }),
    [list.length]
  );

  const handleAdd = () => setList([...list, `Item ${list.length + 1}`]);

  return (
    <div>
      <button onClick={handleAdd}>Add</button>
      <ul>
        {list.map((item, index) => (
          <TodoItem key={index} text={item} />
        ))}
      </ul>
    </div>
  );
}
```

![nested-usememo-memo-deps](react-unstable-nested-components/nested-usememo-memo-deps.png)

ä»å®é™…æµ‹è¯•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰äº†ä¾èµ–é¡¹çš„ `useMemo` + åµŒå¥—ç»„ä»¶ï¼Œåˆé€€åŒ–æˆäº†æœ€å¼€å§‹çš„æ ·å­ï¼Œæ¯æ¬¡éƒ½ä¼šè¢«å½“æˆä¸åŒçš„ç»„ä»¶ç±»å‹ï¼Œæ¯æ¬¡éƒ½ä¼šè¢« unmountã€‚ä¹‹å‰æ‰€åšçš„åŠªåŠ›å…¨éƒ¨æœ¨å¤§ï¼ï¼ˆé¡ºå¸¦ä¸€æç”¨ `useRef` [ä¹Ÿæ˜¯ä¸€æ ·çš„](https://stackblitz.com/edit/react-unstable-nested-components?file=src%2Fcomponents%2F10-nested-useref.jsx)ï¼Œæœ‰ä¾èµ–å°±æ­‡èœï¼‰

ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ä½ çš„åµŒå¥—å­ç»„ä»¶å®Œå…¨ä¸ä¾èµ–çˆ¶ç»„ä»¶ä½œç”¨åŸŸæ—¶ï¼Œæ‰èƒ½ä¿è¯ `useMemo` çš„ç¼“å­˜ä¸€ç›´æœ‰æ•ˆï¼Œæ‰èƒ½åšåˆ°å®Œå…¨ä¸å½±å“æ¸²æŸ“æ€§èƒ½ã€‚ä½†æ—¢ç„¶éƒ½å·²ç»å®Œå…¨ä¸ä¾èµ–äº†ï¼Œé‚£ä¹ˆåˆè¿˜æœ‰ä»€ä¹ˆç†ç”±ä¸€å®šè¦æŠŠå®ƒå®šä¹‰åœ¨çˆ¶ç»„ä»¶å†…éƒ¨å‘¢ï¼Ÿ

## é‡æ„åŒ…å«åµŒå¥—ç»„ä»¶çš„ä»£ç 

æ‰€ä»¥æˆ‘å†é‡å¤ä¸€éå¼€å¤´çš„ç»“è®ºï¼š**æ°¸è¿œä¸è¦åœ¨ React ç»„ä»¶å†…éƒ¨åµŒå¥—å®šä¹‰å­ç»„ä»¶ã€‚**

å› ä¸ºè¿™åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šé€ æˆæ¸²æŸ“é—®é¢˜ï¼Œå³ä½¿å¯¹è¿™ç§å†™æ³•åšä¼˜åŒ–ä¹Ÿæ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºä¸€ä¸ç•™ç¥å°±å¯èƒ½æ‰è¿›å‘é‡Œï¼Œè¿˜æœ‰å¯èƒ½ä¼šè¯¯å¯¼å…¶ä»–çœ‹åˆ°ä½ çš„ä»£ç çš„äººã€‚

å¦‚æœä½ çš„ä»£ç åº“ä¸­å·²ç»æœ‰äº†è¿™æ ·çš„ ğŸ’© ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•é‡æ„ã€‚

**ç¬¬ä¸€ç§æ–¹æ³•ï¼ŒæŠŠå­ç»„ä»¶ç§»åˆ°æœ€å¤–å±‚å»ã€‚**

è¿™ç§æ–¹æ³•é€‚ç”¨äºå­ç»„ä»¶ä¾èµ–é¡¹ä¸å¤šçš„æƒ…å†µï¼Œå¦‚æœæœ‰ä¹‹å‰ç›´æ¥ä½¿ç”¨çš„çˆ¶çº§ä½œç”¨åŸŸä¸­çš„å˜é‡ï¼Œå¯ä»¥å°†å…¶æ”¹é€ ä¸º `props` ä¼ å…¥çš„æ–¹å¼ã€‚

```jsx
// ç»„ä»¶å®šä¹‰ç§»åˆ°æ¨¡å—é¡¶å±‚
const TodoItem = memo((props) => {
  return <li>{`${props.text} of ${props.listLength}`}</li>;
});

function TodoList() {
  const [list, setList] = useState(['Item 1']);

  const handleAdd = () => setList([...list, `Item ${list.length + 1}`]);

  return (
    <div>
      <button onClick={handleAdd}>Add</button>
      <ul>
        {list.map((item, index) => (
          // æ”¹é€ åï¼šä» props ä¼ å…¥åŸæ¥çš„ä¾èµ–é¡¹
          <TodoItem key={index} text={item} listLength={list.length} />
        ))}
      </ul>
    </div>
  );
}
```

**ç¬¬äºŒç§æ–¹æ³•ï¼ŒæŠŠå­ç»„ä»¶æ”¹ä¸ºæ¸²æŸ“å‡½æ•° (Render Function)ã€‚**

JSX çš„æœ¬è´¨å°±æ˜¯ `React.createElement(type)`ï¼ŒReact èŠ‚ç‚¹çš„æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ª JavaScript å¯¹è±¡ã€‚ä½ åœ¨ç»„ä»¶ `return` è¯­å¥ä¸­ç›´æ¥å†™ JSXï¼Œå’Œå®šä¹‰ä¸€ä¸ªå‡½æ•°è¿”å› JSX ç„¶åå†è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚

```jsx
function TodoList() {
  const [list, setList] = useState([]);

  // è¿™ä¸æ˜¯å‡½æ•°ç»„ä»¶ï¼Œåªæ˜¯ä¸€ä¸ªã€Œè¿”å› JSX çš„å‡½æ•°ã€ï¼ˆå‡½æ•°åé¦–å­—æ¯éå¤§å†™ï¼‰
  // æ‰€ä»¥æ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–°åˆ›å»ºä¹Ÿæ²¡é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è®¿é—®ä½œç”¨åŸŸå†…çš„å˜é‡
  const renderTodoItem = (key, text) => {
    return <li key={key}>{`${text} of ${list.length}`}</li>;
  };

  const handleAdd = () => setList([...list, `Item ${list.length + 1}`]);

  return (
    <div>
      <button onClick={handleAdd}>Add</button>
      {/* è°ƒç”¨çš„æ—¶å€™ä¹Ÿå’Œè°ƒç”¨æ™®é€šå‡½æ•°ä¸€æ ·ï¼Œè€Œéç»„ä»¶çš„æ ‡ç­¾å½¢å¼ */}
      <ul>{list.map((item, index) => renderTodoItem(index, item))}</ul>
    </div>
  );
}
```

ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ã€Œæ¸²æŸ“å‡½æ•°ã€æ—¶ï¼Œä¸€å®šè¦ææ¸…æ¥šå’Œã€Œå‡½æ•°ç»„ä»¶ã€çš„åŒºåˆ«ï¼š

- æ¸²æŸ“å‡½æ•°è™½ç„¶å’Œç»„ä»¶ä¸€æ ·éƒ½è¿”å› JSXï¼Œä½†å®ƒä¸æ˜¯ç»„ä»¶ï¼›
- æ¸²æŸ“å‡½æ•°å°±æ˜¯æ™®é€š JavaScript å‡½æ•°ï¼Œæ²¡æœ‰çŠ¶æ€ï¼Œä¹Ÿæ²¡æœ‰å¯¹åº”çš„ Fiber èŠ‚ç‚¹ï¼›
- æ¸²æŸ“å‡½æ•°åªæ˜¯å½“å‰ç»„ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œå¯¹äº React æ¸²æŸ“æ¥è¯´æ²¡æœ‰é¢å¤–å¼€é”€ï¼›
- æ¸²æŸ“å‡½æ•°å†…éƒ¨ä¸èƒ½ä½¿ç”¨ Hooksï¼Œåªæœ‰ç»„ä»¶å†…éƒ¨æ‰èƒ½ä½¿ç”¨ Hooksï¼›
- æ¸²æŸ“å‡½æ•°å‘½åä¸€èˆ¬ä»¥ `render` å¼€å¤´ï¼Œé¦–å­—æ¯å°å†™ï¼ˆå¦åˆ™å®¹æ˜“å’Œç»„ä»¶ææ··ï¼‰ã€‚

å¦å¤–ï¼Œå½“æ¸²æŸ“å‡½æ•°ä½œä¸º `props` ä¼ å…¥å…¶ä»–ç»„ä»¶æ—¶ï¼Œå®ƒä¹Ÿè¢«å«åš[æ¸²æŸ“å±æ€§ (Render Props)](https://legacy.reactjs.org/docs/render-props.html)ã€‚è¿™ç§è®¾è®¡æ¨¡å¼åœ¨ React ç”Ÿæ€ä¸­æœ‰ç€å¤§é‡çš„åº”ç”¨ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚

## ç»“è¯­

æœ€åèŠä¸€ä¸‹ï¼Œå¦‚ä½•é¿å…è¿™ç±»é—®é¢˜çš„å‘ç”Ÿã€‚

**ç¬¬ä¸€ï¼Œé…ç½® Lint è§„åˆ™ã€‚**

é˜²èŒƒäºæœªç„¶ï¼Œåˆç†çš„ Lint é…ç½®å¯ä»¥å‡å°‘èµ·ç  80% çš„ä»£ç è§„èŒƒé—®é¢˜ã€‚æ¯”å¦‚æœ¬æ–‡ä»‹ç»çš„å‘ï¼Œå…¶å®å®Œå…¨å¯ä»¥é€šè¿‡ [`react/no-unstable-nested-components`](https://github.com/jsx-eslint/eslint-plugin-react/blob/master/docs/rules/no-unstable-nested-components.md) + [`react-rfc/no-component-def-in-render`](https://github.com/xgbuils/eslint-plugin-react-rfc/blob/main/docs/rules/no-component-def-in-render.md) è§„åˆ™æå‰è§„é¿ã€‚

æœ€å¥½å†é…åˆä»£ç æäº¤åçš„ CI å¡ç‚¹æ£€æŸ¥ï¼Œæœ‰æ•ˆé¿å…å› å¼€å‘è€…ç¯å¢ƒé…ç½®ä¸å½“æˆ–è€…å·æ‘¸è·³è¿‡æ£€æŸ¥ï¼Œå¯¼è‡´è§„åˆ™å½¢åŒè™šè®¾çš„æƒ…å†µã€‚

**ç¬¬äºŒï¼Œå®šæœŸ Code Reviewã€‚**

ä»£ç è…åŒ–æ˜¯éš¾ä»¥é¿å…çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡æµç¨‹å’Œè§„èŒƒææ—©æš´éœ²ã€çº æ­£é—®é¢˜ï¼Œå‡ç¼“è…åŒ–çš„é€Ÿåº¦ã€‚Code Review åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªçŸ¥è¯†å…±äº«ã€å­¦ä¹ å’Œæˆé•¿çš„è¿‡ç¨‹ï¼Œå¯¹äº reviewer å’Œ reviewee æ¥è¯´éƒ½æ˜¯ã€‚

æ²¡æœ‰äººä¸€å¼€å§‹å°±ä»€ä¹ˆéƒ½ä¼šï¼Œå¤§å®¶éƒ½æ˜¯åœ¨ä¸æ–­çš„å­¦ä¹ ä¸­æˆé•¿èµ·æ¥çš„ã€‚

**ç¬¬ä¸‰ï¼Œäº†è§£ä¸€äº› React çš„åŸç†ä¸å†…éƒ¨å®ç°ã€‚**

å› ä¸ºæˆ‘è‡ªå·±å°±æ˜¯åƒè¿™ç¢—é¥­çš„ï¼Œä¹‹å‰å†™è¿‡ React çš„ Custom Rendererï¼Œä¹Ÿåšè¿‡æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–ï¼Œæ‰€ä»¥åº•å±‚åŸç†çœ‹çš„æ¯”è¾ƒå¤šï¼Œè‡ªç„¶ä¹Ÿå°±çŸ¥é“ä»€ä¹ˆæ ·çš„ä»£ç å¯¹æ€§èƒ½ä¼šæœ‰å½±å“ã€‚

æˆ‘ä¸€ç›´ä»¥æ¥ç§‰æŒçš„è§‚ç‚¹å°±æ˜¯ï¼Œå­¦ä¹ æ¡†æ¶æ—¶ä¹Ÿè¦å­¦ä¹ å®ƒã€Œå¼•æ“ç›–ä¸‹ã€çš„ä¸œè¥¿ï¼ŒçŸ¥å…¶ç„¶ä¸”çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚å¦‚æœä½ å¸Œæœ›åœ¨è¿™æ¡è·¯ä¸Šä¸€ç›´èµ°ä¸‹å»ï¼Œç›¸ä¿¡è¿™ä¸€å®šä¼šå¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚

***

æ‰©å±•é˜…è¯»ï¼š

- [A (Mostly) Complete Guide to React Rendering Behavior](https://blog.isquaredsoftware.com/2020/05/blogged-answers-a-mostly-complete-guide-to-react-rendering-behavior/)
- [How does React do the initial mount internally?](https://jser.dev/2023-07-14-initial-mount/)
- [Rule proposal: react/no-unstable-nested-components](https://github.com/jsx-eslint/eslint-plugin-react/issues/2749)
- [Rule to forbid calling components as functions?](https://github.com/jsx-eslint/eslint-plugin-react/issues/3208)
